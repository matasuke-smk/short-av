# プロジェクト進捗記録

## 2025-11-07 バナー表示問題の修正

### 実施内容

#### 1. 縦画面モーダルバナーが表示されない問題を修正
- **問題**: 縦画面モーダルでDMMウィジェットバナーが表示されない
- **原因**: `landscape:hidden`クラスとJavaScript条件分岐（`!isLandscape`）の二重チェックが競合
- **解決策**:
  - `landscape:hidden`を削除し、JavaScriptの条件分岐のみで制御
  - 横画面モーダルバナーも`hidden landscape:block`から`isLandscape`条件分岐に変更
  - 全てのバナーに`key`プロップを追加して確実に再マウント

#### 2. 縦画面モーダルの余白を削除
- **問題**: 縦画面モーダルのバナーとアイフレームに上下左右の余白が表示される
- **解決策**:
  - モーダル親要素の`p-4`パディングを削除（縦画面時）
  - バナーとアイフレームを画面いっぱいに表示

#### 3. 画面の向き変更時のバナー重複問題を解決
- **問題**: モーダル表示中に横画面から縦画面に切り替えるとバナーが2枚に増える
- **原因**: 画面の向きが変わる際、新旧両方のバナーが一瞬DOM上に存在し、DMMスクリプトが両方を処理
- **解決策**:
  - `showVideoModalRef`を追加してモーダルの開閉状態を追跡
  - 画面の向きが変わった時、モーダルを一度閉じる
  - 50ms後にモーダルを再度開くことで、古いバナーを完全にアンマウントしてから新しいバナーをマウント
  - `modalKey`をインクリメントして完全な再マウントを保証

### コミット一覧

```
3bdc0b1 [修正] 画面の向き変更時にモーダルを一度閉じて再度開く
0316283 [修正] バナー重複問題をmodalKeyによる再マウントで解決
36f5c77 [修正] 画面の向き変更時に全てのバナーを強制クリーンアップ
58cec6d [修正] 画面の向き変更時にバナーが重複する問題を修正
f1ba9db [修正] 縦画面モーダルの余白を完全に削除
c359d18 [修正] 縦画面モーダルバナーの余白を完全に削除
b327032 [修正] 横画面モーダルバナーもJavaScript条件分岐で制御
9dc5d6f [修正] 全てのバナーにkeyプロップを追加して再マウントを確実に
7532893 [修正] 縦画面モーダルに上部パディングを追加
325d8c1 [修正] landscape:hiddenとJavaScript条件分岐の競合を解消
fb455fa [修正] 縦画面モーダルバナーの表示問題を修正
a97166f [修正] 縦画面モーダルバナーが表示されない問題を修正
```

### 最終的な実装状況

#### バナー実装完了
- ✅ **縦画面サムネイル下バナー** (640×200)
  - `landscapeBannerIds[currentIndex % 10]`
  - スワイプごとにローテーション

- ✅ **横画面サムネイル横バナー** (640×200)
  - `landscapeBannerIds[(currentIndex + 3) % 10]`
  - スワイプごとにローテーション

- ✅ **縦画面モーダルバナー** (640×200)
  - `landscapeBannerIds[(currentIndex + 5) % 10]`
  - 余白なし、画面の向き変更時の重複問題解消

- ✅ **横画面モーダルバナー** (160×600)
  - `portraitBannerIds[currentIndex % 2]`
  - スワイプごとにローテーション

#### 技術的な実装ポイント
- 全てのバナーがDMMウィジェット形式（`<ins class="widget-banner"></ins>` + 外部スクリプト）
- スワイプごとに異なるバナーが表示される
- 画面の向きを変更してもバナーが正しく切り替わり、重複しない
- JavaScript条件分岐（`isLandscape`, `!isLandscape`）でバナー表示を制御
- `useRef`と`modalKey`を使用した確実な再マウント機構

### 修正ファイル
- `app/components/VideoSwiper.tsx` - メインの実装ファイル
- `app/components/DMMBanner.tsx` - バナーコンポーネント（変更なし）
- `config/banners.ts` - バナーID設定（変更なし）

---

## 過去の実装履歴

### バナーローテーション機能の実装（実装日不明）
- スワイプごとに異なるバナーを表示する機能を実装
- 横画面・縦画面それぞれのバナーを追加
- DMMウィジェット方式での実装
