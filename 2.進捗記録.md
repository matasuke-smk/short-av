# DMMアフィリエイト ハイブリッド型 動画閲覧サイト - 進捗記録

## プロジェクト概要
- **プロジェクト名**: short-av.com
- **開始日**: 2025年（記録開始）
- **技術スタック**: Next.js 14, TypeScript, Supabase, Vercel

---

## Phase 1: MVP（最小実行可能製品）

### 完了項目
- [x] Next.js プロジェクト初期セットアップ
- [x] サムネイル表示の4:3縦横比固定
- [x] レイアウトの基本実装
- [x] Next.js 15のsearchParams非同期対応
- [x] ランダム表示機能の実装
- [x] iPhoneブラウザ対応レイアウト（dvh、Safe Area対応）
- [x] いいね機能完全実装（API、DB、UI）
- [x] いいね済み動画一覧ページ（/liked）
- [x] Vercelデプロイ・ドメイン連携（short-av.com）
- [x] データベース設計・構築（Supabase）
- [x] 年齢確認ゲート実装
- [x] 初回チュートリアル実装
- [x] コンプライアンス対応（広告・PR表記、景表法）
- [x] プライバシーポリシーページ作成
- [x] 利用規約ページ作成
- [x] DMM API連携基盤構築
- [x] Vercel Cronによる自動更新システム
- [x] アフィリエイトリンク一時無効化システム（環境変数制御）
- [x] 記事メニュー基本実装（5件のサンプル記事）

### 進行中
- [ ] 記事コンテンツの充実（現在5件サンプル、内容を追加予定）
- [ ] DMMアフィリエイトサイト申請対応
- [ ] 基本的なSEO設定（メタタグ、sitemap.xml）

### 未着手
- [ ] （なし）

---

## Phase 2: スワイプUI実装

### 完了項目
- [ ] スワイプUIコンポーネント実装
- [ ] 動画カード、プリロード機能
- [ ] History API連携
- [ ] セクションA⇔セクションBの相互リンク

### 進行中
- [ ] （未着手）

### 未着手
- [ ] （全て）

---

## Phase 3: 自動化・SEO強化

### 完了項目
- [x] Vercel Cronによる自動更新システム

### 進行中
- [ ] （未着手）

### 未着手
- [ ] ISR実装
- [ ] 構造化データ（VideoObject）実装
- [ ] Core Web Vitals最適化
- [ ] Google Analytics 4、Search Console連携

---

## Phase 4: 運用・改善

### 完了項目
- [ ] （未着手）

### 進行中
- [ ] （未着手）

### 未着手
- [ ] アクセス解析に基づく記事追加
- [ ] A/Bテスト（記事レイアウト、CTAボタン配置）
- [ ] パフォーマンスモニタリング
- [ ] コンバージョン率改善

---

## 技術的な課題・メモ

### 解決済み
- サムネイルの縦横比を4:3に固定（2025-10-27）
- レイアウトの微調整完了（最近のコミット）
- Next.js 15の非同期searchParams対応完了
- iPhoneブラウザでのレイアウト問題（2025-10-28）
- いいねボタンの表示問題（z-index、型エラー）（2025-10-28）
- Supabaseマイグレーションの型不一致（UUID vs TEXT）（2025-10-28）
- DMM API連携基盤構築完了（2025-10-28深夜）
- Vercel Cron自動更新システム実装完了（2025-10-28深夜）

### 現在の課題
- **DMMアフィリエイトサイト申請対応中**
  - アフィリエイトリンク一時無効化中（環境変数制御）
  - オリジナルコンテンツ（記事）を5件追加済み
  - 新しいアフィリエイトID発行待ち
- SEO対策実装（robots.txt、sitemap.xml、OGP、構造化データ）
- 記事ページ内容の充実

### TODO（優先度高）
- **アフィリエイトID発行後の有効化**（新しいIDが発行され次第）
  - 手順: この文書の「アフィリエイトID発行後の復元手順」セクション参照
  - `.env.local` と Vercel環境変数を更新
  - `NEXT_PUBLIC_ENABLE_AFFILIATE_LINKS=true` に変更
  - ⏱️ 所要時間: 5分程度（コード変更不要）
- **記事コンテンツの充実**
  - 現在: 5件のサンプル記事（空のコンテンツ）
  - 目標: 実際の有益なコンテンツを追加
  - 編集ファイル: `app/components/ArticleModal.tsx`
- **SEO対策実装**（1-2週間以内）
  - robots.txt作成（`app/robots.ts`）
  - sitemap.xml作成（`app/sitemap.ts`）
  - OGP設定（全ページ）
  - 詳細: `SEO評価レポート_2025-10-29.md`参照

### TODO（優先度中）
- ISR実装
- 構造化データ（VideoObject）実装
- Core Web Vitals最適化

### TODO（優先度低）
- Google Analytics 4、Search Console連携
- パフォーマンスモニタリング
- A/Bテスト実装

---

## 最近の更新履歴

### 2025-10-30
- **アフィリエイトリンク一時無効化システム実装**
  - 環境変数`NEXT_PUBLIC_ENABLE_AFFILIATE_LINKS`による制御機能を実装
  - 理由: DMMアフィリエイトのサイト申請でオリジナルコンテンツ不足を指摘された
  - 無効化される要素:
    - FANZAクレジット（画面上部）
    - 640×200バナー広告
    - フル動画購入ボタン（モーダル内）
    - サンプル動画URL内のアフィリエイトID（/affi_id=xxx/）
  - プレースホルダー表示: 「サイト認証後に表示」と表示し、領域を明確化
  - 復元方法: 環境変数を`true`に変更するだけで即座に有効化可能
- **動画URLアフィリエイトID削除機能**
  - `removeAffiliateIdFromUrl()`関数を実装
  - DMMから返される`sample_video_url`に含まれる`/affi_id=matasuke-990/`を削除
  - iframe表示時にもアフィリエイトIDが表示されないように改善
- **オリジナルコンテンツとして記事メニュー追加**
  - 動画タイトル欄右端に本アイコンを追加
  - `ArticleModal`コンポーネント実装（5件のサンプル記事）
  - 記事一覧と詳細画面の切り替え機能
  - 将来的に実際のコンテンツを追加可能

### 2025-10-29
- **検索モーダルとスワイプの同期問題を完全修正**
  - ホームボタン再読み込み後の検索結果の順序問題を解決
  - currentIndexとinitialOffsetの混同を修正（配列内位置とDB位置を分離）
  - SearchModalからの動画選択でページリロードを廃止（emblaApi.scrollToを使用）
  - 検索結果ページでのstartIndex設定を正しく実装
  - isSearchResult判定をURLパラメータベースに改善
- **アフィリエイト設定の整理**
  - DMMアフィリエイトIDを一時的に削除（af_id=matasuke-002）
    - 理由: サイトURL変更により元のIDが使用不可
  - `config/affiliate.md`を作成（復元手順をドキュメント化）
  - 別セッションでも簡単に復元可能な構造に
- **タイトル変更**
  - 「Short AV - 動画レビューサイト」→「Short AV」
  - よりシンプルでブランディングに適したタイトルに
- **SEO評価レポート作成**
  - 総合評価: 40/100（要改善）
  - robots.txt、sitemap.xml、OGP、構造化データなどが未実装
  - 改善後の予想スコア: 75/100
  - 詳細は`SEO評価レポート_2025-10-29.md`を参照
- **検索モーダル無限スクロール実装（夜）**
  - フィルタ検索結果（ジャンル/女優選択）での無限スクロール機能実装
  - ブラウズモード（ホーム画面動画リスト）での無限スクロール実装
  - スクロール位置が下から200px以内で自動読み込み
  - videoListRefの適切なDOM要素へのアタッチ
  - isOpenガードによるスクロールイベント最適化
- **ホームボタン動作改善**
  - Next.jsクライアント側ルーティングからwindow.location.hrefによるフルリロードに変更
  - 毎回ランダムな動画が表示されるように改善
- **動画選択時のスクロール動作改善試行**
  - フィルタ検索結果からの動画選択時の表示改善を複数アプローチで試行
  - emblaApi.scrollTo()の動作とReactの再レンダリングの関係を分析
  - 最終的に現在の仕様（スクロールあり）で進めることを決定
  - 技術的制約: setVideos()による再レンダリングでEmblaが先頭にリセットされるため、scrollTo()を使用すると必ずスクロール動作が発生する

### 2025-10-28（深夜）
- DMM API連携完全実装
  - API関数の修正（site, service, floorパラメータを明示的に指定）
  - DMM APIリファレンスドキュメント作成（lib/dmm-api-reference.md）
  - APIテストスクリプト作成（scripts/test-dmm-api.ts）
  - データ更新スクリプト作成（scripts/update-videos.ts）
  - 200件の動画データをSupabaseに保存成功
- Vercel Cron自動更新システム実装
  - /api/cron/update-videosエンドポイント作成
  - 6時間ごとに自動でDMM APIからデータ取得・DB更新
  - CRON_SECRET認証実装
  - vercel.jsonでスケジュール設定

### 2025-10-28（夜）
- コンプライアンス対応完了
  - トップページ上部に「広告・PR」表記を追加（景表法・ステマ規制対応）
  - プライバシーポリシーページ作成（/privacy）
  - 利用規約ページ作成（/terms）
  - フッターにポリシーページへのリンクを追加
- 年齢確認ゲート完全実装
  - 毎日初回のみ表示
  - 「広告・PR」表記付き
  - デバッグ用URL（?show_gate=1）対応
- 初回チュートリアル実装
  - 年齢確認後に自動表示
  - スワイプとタップの操作説明
  - 画面中央配置で見やすく

### 2025-10-28（朝）
- iPhoneブラウザ対応レイアウト最適化（動的ビューポート高さ、Safe Area）
- タイトル、サムネイル、バナー間の余白削除
- いいねボタン実装（サムネイル左下）
  - LocalStorageベースのユーザー識別
  - API Routes作成（/api/likes/toggle, /api/likes/my-likes）
  - Supabaseにlikesテーブル追加
  - いいね数の自動カウント機能
- いいね済み動画一覧ページ作成（/liked）
- Supabaseマイグレーション実行完了
- ドメイン設定完了（short-av.com）

### 2025-10-27
- サムネイルの4:3縦横比を確実に適用
- レイアウトの微調整
- Next.js 15のsearchParams非同期対応
- ランダム表示とレイアウト固定化を修正

---

## 参考リンク
- 要求仕様書: `app/1.要求仕様書.txt`
- DMM APIリファレンス: `lib/dmm-api-reference.md`
- **アフィリエイトID復元手順**: このファイルの下部セクション参照 ⭐ **重要**
- SEO評価レポート: `SEO評価レポート_2025-10-29.md`
- Vercelダッシュボード: https://vercel.com/dashboard
- DMM API 公式ドキュメント: https://affiliate.dmm.com/api/
- Supabase ダッシュボード: https://bdfgttmnztstxpxxbeif.supabase.co

## ⭐ アフィリエイトID発行後の復元手順（2025-10-30更新）

新しいアフィリエイトIDが発行されたら、以下の手順でアフィリエイトリンクを有効化してください。

### 🚀 クイックガイド（3ステップ）

#### **ステップ1: ローカル環境設定**

`.env.local` を編集：
```bash
# DMM アフィリエイトID を更新
DMM_AFFILIATE_ID=新しいID（例: matasuke-123）

# アフィリエイトリンク表示を有効化
NEXT_PUBLIC_ENABLE_AFFILIATE_LINKS=true
```

#### **ステップ2: Vercel環境変数設定**

1. [Vercelダッシュボード](https://vercel.com/dashboard) にアクセス
2. プロジェクト → Settings → Environment Variables
3. 以下の2つを編集/追加：
   - `DMM_AFFILIATE_ID`: `新しいID`
   - `NEXT_PUBLIC_ENABLE_AFFILIATE_LINKS`: `true`
4. Environment: **Production, Preview, Development** すべて選択
5. Save

#### **ステップ3: デプロイ**

```bash
git add .env.local
git commit -m "アフィリエイトID更新と有効化"
git push origin main
```

Vercelで自動デプロイが開始されます。デプロイ完了後、サイトにアクセスして以下を確認：
- ✅ 画面上部に「Powered by FANZA Webサービス」が表示される
- ✅ 640×200バナー広告が表示される
- ✅ 動画モーダル内に「フル動画はこちら」ボタンが表示される
- ✅ プレースホルダー「サイト認証後に表示」が消えている

### 📝 詳細情報

**無効化されているアフィリエイト要素:**
- FANZAクレジット（画面上部）
- 640×200バナー広告
- フル動画購入ボタン（モーダル内）
- サンプル動画URL内のアフィリエイトID

**技術的な仕組み:**
- 環境変数 `NEXT_PUBLIC_ENABLE_AFFILIATE_LINKS` で表示を制御
- `DMM_AFFILIATE_ID` はDMM APIリクエストとURL生成に使用
- コードの変更不要、環境変数の変更のみで制御可能

**参考:**
- 元のID: `matasuke-990`（使用不可）
- 新しいIDの取得先: [DMMアフィリエイト](https://affiliate.dmm.com/)

---

## メモ・アイデア
- （思いついたアイデアや改善案をここに記録）
