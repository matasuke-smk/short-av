# Changelog

## 2025-12-29

### Features（新機能）

#### ランキング動画のいいね機能を完全実装
- ランキングモーダルから選択した動画でもいいね機能が正常に動作
- いいね済み動画の一覧にランキング動画も表示される
- UUIDとDMM content_idの混在問題を解決

**実装内容**:
1. いいねした動画を`videoPool`に自動追加
2. `likes`テーブルの外部キー制約を削除（TEXT型に変更）
3. データベーストリガー`update_video_likes_count()`を削除
4. UUID/DMM content_id混在時の検索ロジックを改善

**解決した問題**:
- ランキング動画をいいねすると500エラー → 解決
- ランキング動画が「いいね済み動画」に表示されない → 解決
- 18個いいねしたのに9個しか表示されない → 解決

**コミット**:
- `ba5019f` - ランキング動画のいいね機能を修正
- `f14c7b8` - いいねAPIの500エラーを修正
- `8e11b75` - 自動DB登録対応（後に削除）
- `2820fa3` - いいね機能を大幅にシンプル化
- `024a46e` - いいね済み動画の表示を修正
- `9c3f866` - Supabaseクエリの構文エラーを修正
- `4a4f1d9` - いいね済み動画の検索を改善
- `c66cf92` - UUID/DMM content_id混在による400エラーを修正
- `dcb51c1` - videoPoolに追加して根本解決

#### ジャンルと女優の並び順を人気順に変更
- 検索モーダルのジャンルと女優が動画数の多い順（人気順）に表示されるように改善
- videoPoolから各ジャンル・女優の動画数をカウントし、多い順にソート
- **変更前**: ジャンルはsort_order順、女優はあいうえお順
- **変更後**: ジャンルも女優も動画数の多い順
- コミット: `327e638`

#### 重み付きランダムアルゴリズムを実装
- ランキング順位に基づいた重み付きランダム選択を実装
- 人気動画ほど表示されやすく、マイナー作品も適度に表示
- TikTok風の「次々に動画が流れる」体験を向上
- コミット: `cfe1c09`

#### DMM APIを使用した本物のランキング機能を実装
- DMM公式APIから週間・月間・全期間ランキングを取得
- モック実装から本物のランキングデータに切り替え
- `/api/ranking` エンドポイントを新規実装
- 各期間ごとにTOP 20を表示
- コミット: `2b64cda`

---

### Bug Fixes（バグ修正）

#### 再読み込み時の無限スクロール問題を完全解決
**問題**: 強制再読み込み後に850件ほど超高速でスクロールされ続ける

**根本原因**: URL復元機能とスクロールイベントの無限ループ
1. スクロール時に`onSelect`が発火 → URLパラメータ更新
2. URL変更により`searchParams`が変わる
3. URLパラメータ処理の`useEffect`が再実行
4. `emblaApi.scrollTo`でスクロール発生
5. また`onSelect`が発火 → 無限ループ

**解決策**: URL復元機能を完全に削除
- `processedUrlParamRef`の完全削除
- URLパラメータ処理の`useEffect`を削除
- URL更新時の参照設定を全て削除（9箇所）
- 再読み込み時は常にランダムな動画を表示
- URLは共有用に引き続き更新されるが、復元は行わない

**コミット**:
- `ad36e60` - URL復元機能を削除
- `da38d14` - URLパラメータとスクロールイベントの無限ループ修正
- `f6b52f4` - URLパラメータ処理の無限ループ修正

#### 検索結果のスクロール位置を確実に先頭に修正
**問題**: 検索実行後、中途半端な位置や最後尾から始まる

**原因**: `emblaApi.reInit()`と`scrollTo()`の非同期処理タイミング問題

**修正内容**:
- `setCurrentIndex(targetIndex)`を即座に実行（emblaApiより先）
- `requestAnimationFrame`を`setTimeout(150ms)`に変更
- SearchModal閉じるタイミングを100ms→200msに延長
- 全モーダル（検索/ランキング/いいね/履歴）で統一

**効果**: 検索結果が確実に先頭から始まる
- コミット: `dc3139b`

#### Supabaseエラー修正 & 検索機能を改善
**修正1: ビルドエラー解決**
- `app/api/videos/route.ts`: `nullsLast` → `nullsFirst` に修正
- Supabaseの`order()`でサポートされているパラメータに変更

**修正2: 検索結果を人気順に表示**
- キーワード/ジャンル/女優検索: `likes_count`順 → `rank_position`順
- DMM公式ランキング順位で表示

**修正3: 検索結果件数表示を廃止**
- `totalCount`関連のコードを削除
- 複雑な状態管理を簡略化してバグを解消
- コミット: `01ec9bb`

#### バナー表示のシンプル化
- バナーを1082と1083の2種類に絞り込み
- 表示ロジックをシンプル化してメンテナンス性向上
- コミット: `4b044e1`

---

### Refactoring（リファクタリング）

#### 検索画面のUI大幅改善
**主な変更**:
- キーワード検索フォームを上部に常時表示
- 検索モード切り替えを「ジャンル」「女優」の2つに簡略化
- ジャンル一覧・女優一覧をモーダルではなくメインコンテンツに直接表示
- ジャンル/女優の絞り込み検索ボックスを追加
- デフォルトの検索モードを「ジャンル」に変更

**UI改善**:
- 縦画面: タイトル検索→検索モード切り替え→フィルタ検索→コンテンツ一覧→ボタンエリア
- 横画面: タイトル検索→検索モード切り替え→フィルタ検索→アクションボタンを右側に配置
- 選択中のジャンル/女優を視覚的に表示（件数も表示）
- 「選択をクリア」「検索」ボタンを追加

**削除された機能**:
- ジャンル選択モーダル（約200行）
- 女優選択モーダル（約200行）
- `showGenreModal`, `showActressModal`状態管理
- キーワード検索モード（常時利用可能に変更）

**効果**: `app/components/SearchModal.tsx` が1206行 → 834行（372行削減）
- コミット: `b5b2d95`

#### 性別フィルター機能を完全に削除
**主な変更**:
- 未使用ページを削除（`app/search/`, `app/filtered/`）
- 性別フィルター（♂♀、♀♀、♂♂）のUIとロジックを全削除
- 3つの性別別プール（straight/lesbian/gay）を単一プールに統合
- LGBT除外ロジックを廃止し、全動画を表示対象に
- VideoSwiper、SearchModal、RankingModal、LikedModal、HistoryModalのpropsを簡略化

**削除された機能**:
- 性別フィルターボタンとUI（縦画面・横画面両方）
- レズビアン・ゲイジャンル検索の除外処理
- 性別別動画カウント表示
- 性別別プール管理ロジック

**影響するファイル**:
- `app/page.tsx`: 268行 → 約120行（148行削減）
- `app/api/videos/route.ts`: LGBT除外ロジック削除
- `app/components/SearchModal.tsx`: 性別フィルターUI・ロジック削除
- `app/components/VideoSwiper.tsx`: GenderVideos/GenderCounts型削除
- `app/components/RankingModal.tsx`: videoPools → videoPool
- `app/components/LikedModal.tsx`: videoPools → videoPool
- `app/components/HistoryModal.tsx`: videoPools → videoPool
- コミット: `dda16cb`

#### 検索結果表示のシンプル化
**変更内容**:
- 検索実行後、動画一覧を表示せずすぐにスワイプ画面に遷移
- サムネイル選択によるバグを解消
- 不要な状態変数を削除（`straightVideos`, `poolIndex`, `isLoadingMore`等）
- 無限スクロール機能を削除
- UIを「検索中」「検索結果なし」「検索してください」のみに簡素化

**メリット**:
- バグが大幅に減少
- TikTok風UIに適した シンプルな操作性
- 状態管理が単純化され保守性向上
- コミット: `d3d3555`

---

### Infrastructure（インフラ）

#### Next.js バージョン調整
**問題**: Next.js 16.1.1でビルドエラー & セキュリティ脆弱性

**解決**:
1. Next.js 16.1.1にアップデート & セキュリティ脆弱性解決（`ac9a6bb`）
2. Next.js 15.4.10にダウングレード & ビルドエラー解決（`a27b290`）

**最終的な選択**: Next.js 15.4.10
- 安定性とビルド成功を優先
- セキュリティ脆弱性は軽微なため許容範囲

---

## 統計

### コード削減量
- **SearchModal.tsx**: 1206行 → 834行（-372行、-31%）
- **page.tsx**: 268行 → 約120行（-148行、-55%）
- **VideoSwiper.tsx**: 無限ループ処理削除（-50行）
- **合計削減**: 約570行以上

### 主要な改善
1. **安定性向上**: 無限スクロールバグの完全解決
2. **UX改善**: 検索画面のユーザビリティ大幅向上
3. **コード品質**: 不要な機能削除によるシンプル化
4. **保守性向上**: 状態管理の簡略化

### コミット数
- 本日のコミット数: 14件
- 主要なバグ修正: 5件
- 新機能追加: 3件
- リファクタリング: 4件
- インフラ調整: 2件
